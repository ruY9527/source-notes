##                              分布式锁



####  题记

   最近我负责的模块(基于上一个辞职交接给我的),在老的版本上进行优化处理,从之前的的那个到如今的批量的处理,从下游服务是一个,到下游服务部署多个(负载均衡,使用的是ribbon的权重负载均衡,可能是由于只部署了二个,所以导致出来的看到的现象不是十分的明显,没有很明显的体会到权重的效果.这里说远了...).  

​    **最主要的是,下游服务在接收到我的请求后,就立马给请求的数据写入到kafka中,然后用consumer来消费,所以下游也就异步了,并且同时部署了多个,也就是消费的数据的时候,是需要确保一定是顺序的。 比如我是先添加数据，在去更新数据, 如果下游没有把握好，让更新的线程走到了插入的前面,那么这里就出问题了(这里是因为下游部署了二个).  于是, 有关联的部分就需要加上分布式锁了.**  这也就是为什么要加的原因。当然了，程序肯定是不加锁要比加锁牛噢，毕竟你能给 加锁优化到不加锁就是很牛的了。



------



####  过程

  

   由于之前有一个项目,小组长使用过了redis来实现分布式锁,具体使用的就是 jedis来实现，于是我也就是很不厚道的给copy过来了， 由于这里不想每个方法都去写一个 lock  / unlock 的，于是就使用了 aop来进行处理, 对 处理业务的主要逻辑方法, 使用aop.   看似看玩美的操作， 于是上传 10 w + 的数据来测试下, 咔咔咔的爆了一个莫名其妙的错误。 



爆出来的异常,大致的连接不够。其实我这里百思不得理解的一个问题，我为什么会有那么多线程呢？为什么会有那么多线程新争抢获取锁呢？ 后来和同事讨论了下，原因是因为我们这个服务使用的是kafka集群，于是就有了多个 consumer 去消费数据, 而且这个服务也是二个,于是在一个的基础上在加个倍。但是这也不是导致连接jedis连接不够的原因吧？  这个由于技术和时间有限，因为这个项目急于发布, 就没去仔细找原因和仔细测试。但是有同事提到了,linux自身开发的连接也就是 1024 (这里肯定还有其他的连接也会占用一个吧,我们是使用的aws的云服务器),   也算提供的一种思路吧.  于是在 第二天还是会有这个问题, 于是转而使用 redssion这个框架来实现,但是出现的频率比起jedis是少了很多。 在仔细测试后, 就没有出现这个超时的问题了.



TODO  之后更新下具体的错误异常, 然后 baidu 一下, 看了一下处理方法 , 果不其然 , 没有一个可以处理的. 于是各种修改redis配置, 升级 jedis ，由于升级jedis ， 导致之前可以使用的api, 在升级后不能使用了, 很蛋痛, 于是修修改改，各种测试，还是不行。 



------------------------------------------ 华丽分割线 -------

稍后仔细去了解下, 然后再更新吧，但是不得不说的是  , redssion 在这方面确实比 jedis强.



####  文献参考地址

 [redission](https://github.com/redisson/redisson)

 